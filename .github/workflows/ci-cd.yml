name: ðŸš€ Deploy Node App to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

concurrency:
  group: main-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # --------------------------------------------
      # STEP 1: Checkout repository
      # --------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------
      # STEP 2: Validate secrets
      # --------------------------------------------
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ] || [ -z "${{ secrets.EC2_USER }}" ] || [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âŒ Missing one or more required secrets (EC2_HOST, EC2_USER, EC2_SSH_KEY)."
            exit 1
          else
            echo "âœ… All required secrets are set."
          fi

      # --------------------------------------------
      # STEP 3: Ensure deployment directory on EC2
      # --------------------------------------------
      - name: Prepare backend directory on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/${{ secrets.EC2_USER }}/app
            sudo chown -R $USER:$USER /home/${{ secrets.EC2_USER }}/app
            sudo chmod -R 755 /home/${{ secrets.EC2_USER }}/app

      # --------------------------------------------
      # STEP 4: Upload code to EC2 via SCP
      # --------------------------------------------
      - name: Upload project to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: .
          target: /home/${{ secrets.EC2_USER }}/app
          overwrite: true

      # --------------------------------------------
      # STEP 5: Deploy Node app on EC2
      # --------------------------------------------
      - name: Run deployment commands
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DIR: /home/${{ secrets.EC2_USER }}/app
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            echo "ðŸš€ Starting Node.js app deployment..."
            cd /home/${{ secrets.EC2_USER }}/app

            # Install Node.js and PM2 if not already installed
            if ! command -v node &> /dev/null; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2 globally..."
              sudo npm install -g pm2
            fi

            # Install dependencies
            npm install --force

            # Create logs directory
            mkdir -p logs

            # Restart or start app using PM2
            APP_NAME="ngo-app"
            pm2 stop $APP_NAME || true
            pm2 delete $APP_NAME || true
            pm2 start npm --name "$APP_NAME" -- start

            pm2 save
            pm2 startup systemd -u $USER --hp $HOME

            echo "âœ… Deployment successful! Node.js app is running on port 8000."
